<!DOCTYPE html>
<html>
<head>
    <title>psi-feature-burnup</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var acceptedData=[],myMask=null,app=null;Ext.define("CustomApp",{scopeType:"release",extend:"Rally.app.App",componentCls:"app",launch:function(){app=this;var that=this;console.log("launch"),this.project=this.getContext().getProject().ObjectID;var tbName=getReleaseTimeBox(this),configs=[];configs.push({model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]}),configs.push({model:"Release",fetch:["Name","ObjectID","Project","ReleaseStartDate","ReleaseDate"],filters:[]}),configs.push({model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:[]}),async.map(configs,this.wsapiQuery,function(err,results){that.peRecords=results[0],that.releases=results[1],that.iterations=results[2],that.createReleaseCombo(that.releases)})},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},createReleaseCombo:function(releaseRecords){var releases=_.map(releaseRecords,function(rec){return{name:rec.get("Name"),objectid:rec.get("ObjectID"),releaseDate:new Date(Date.parse(rec.get("ReleaseDate")))}});releases=_.uniq(releases,function(r){return r.name}),releases=_.sortBy(releases,function(rec){return rec.releaseDate}).reverse();var releasesStore=Ext.create("Ext.data.Store",{fields:["name","objectid"],data:releases}),cb=Ext.create("Ext.ux.CheckCombo",{fieldLabel:"Release",store:releasesStore,queryMode:"local",displayField:"name",valueField:"name",noData:!0,width:300,listeners:{scope:this,collapse:function(field,eOpts){var r=[];_.each(field.getValue().split(","),function(rn){var matching_releases=_.filter(releaseRecords,function(r){return rn==r.get("Name")}),uniq_releases=_.uniq(matching_releases,function(r){return r.get("Name")});_.each(uniq_releases,function(release){r.push(release)})}),r.length>0&&(myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),myMask.show(),this.selectedReleases=r,this.queryFeatures(r))}}});this.add(cb)},queryFeatures:function(releases){var that=this,filter=null;return _.each(releases,function(release,i){var f=Ext.create("Rally.data.QueryFilter",{property:"Release.Name",operator:"=",value:release.get("Name")});filter=0===i?f:filter.or(f)}),Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"PortfolioItem/Feature",limit:"Infinity",fetch:["ObjectID","FormattedID"],filters:[filter],listeners:{load:function(store,features){that.createChart(features,releases)}}})},createChart1:function(features,releases,start,end){var that=this,lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(features,function(d){return d.data}),holidays=[{year:2014,month:1,day:1}],myCalc=Ext.create("MyBurnCalculator"),config={deriveFieldsOnInput:myCalc.getDerivedFieldsOnInput(),metrics:myCalc.getMetrics(),summaryMetricsConfig:[],deriveFieldsAfterSummary:myCalc.getDerivedFieldsAfterSummary(),granularity:lumenize.Time.DAY,tz:"America/Chicago",holidays:holidays,workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday"},startOnISOString=new lumenize.Time(start).getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time(end).getISOStringInTZ(config.tz);calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"label"},{name:"Planned Points"},{name:"PreliminaryEstimate"},{name:"Accepted Points"},{name:"Projection"},{name:"Count",type:"column"},{name:"Completed",type:"column"}],hc=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig);this._showChart(hc)},createPlotLines:function(seriesData){var start=new Date(Date.parse(seriesData[0])),end=new Date(Date.parse(seriesData[seriesData.length-1])),releaseI=_.filter(this.iterations,function(i){return i.get("EndDate")>=start&&end>=i.get("EndDate")});releaseI=_.uniq(releaseI,function(i){return i.get("Name")});var itPlotLines=_.map(releaseI,function(i){var d=new Date(Date.parse(i.raw.EndDate)).toISOString().split("T")[0];return{label:i.get("Name"),dashStyle:"Dot",color:"grey",width:1,value:_.indexOf(seriesData,d)}}),rePlotLines=_.map(this.selectedReleases,function(i){var d=new Date(Date.parse(i.raw.ReleaseDate)).toISOString().split("T")[0];return{label:i.get("Name"),color:"grey",width:1,value:_.indexOf(seriesData,d)}});return itPlotLines.concat(rePlotLines)},createChart:function(features,releases){var ids=_.pluck(features,function(feature){return feature.get("ObjectID")}),start=_.min(_.pluck(releases,function(r){return r.get("ReleaseStartDate")})),end=_.max(_.pluck(releases,function(r){return r.get("ReleaseDate")})),isoStart=Rally.util.DateTime.toIsoString(start,!1),storeConfig={find:{_TypeHierarchy:{$in:["PortfolioItem/Feature"]}},autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:["ObjectID","_TypeHierarchy","PreliminaryEstimate","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount"],hydrate:["_TypeHierarchy"]};storeConfig.find.ObjectID={$in:ids},storeConfig.find._ProjectHierarchy={$in:this.project},storeConfig.find._ValidTo={$gte:isoStart},storeConfig.listeners={scope:this,load:function(store,features,success){this.createChart1(features,releases,start,end)}};var snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},_showChart:function(series){var chart=this.down("#chart1");myMask.hide(),null!==chart&&chart.removeAll();var plotlines=this.createPlotLines(series[0].data);series[1].data=_.map(series[1].data,function(d){return _.isNull(d)?0:d});var extChart=Ext.create("Rally.ui.chart.Chart",{itemId:"chart1",chartData:{categories:series[0].data,series:series.slice(1,series.length)},chartColors:["Gray","Orange","Green","LightGray","Blue","Green"],chartConfig:{chart:{},title:{text:"PSI Feature Burnup",x:-20},plotOptions:{series:{marker:{radius:2}}},xAxis:{plotLines:plotlines,tickInterval:7,labels:{formatter:function(){var d=new Date(this.value);return""+(d.getMonth()+1)+"/"+d.getDate()}}},yAxis:{title:{text:"Count"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{},legend:{align:"center",verticalAlign:"bottom"}}});this.add(extChart),chart=this.down("#chart1");var p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})}});
                Ext.define("Ext.ux.CheckCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.checkcombo",multiSelect:!0,allSelector:!1,noData:!1,noDataText:"No combo data",addAllSelector:!1,allSelectorHidden:!1,enableKeyEvents:!0,afterExpandCheck:!1,allText:"All",oldValue:"",listeners:{focus:function(cpt){cpt.oldValue=cpt.getValue()},keydown:function(cpt,e,eOpts){var value=cpt.getRawValue(),oldValue=cpt.oldValue;value!=oldValue&&cpt.setValue("")}},createPicker:function(){var me=this,picker,menuCls=Ext.baseCSSPrefix+"menu",opts=Ext.apply({pickerField:me,selModel:{mode:me.multiSelect?"SIMPLE":"SINGLE"},floating:!0,hidden:!0,ownerCt:me.ownerCt,cls:me.el.up("."+menuCls)?menuCls:"",store:me.store,displayField:me.displayField,focusOnToFront:!1,pageSize:me.pageSize,tpl:['<ul><tpl for=".">','<li role="option" class="'+Ext.baseCSSPrefix+'boundlist-item"><span class="x-combo-checker">&nbsp;</span> {'+me.displayField+"}</li>","</tpl></ul>"]},me.listConfig,me.defaultListConfig);return picker=me.picker=Ext.create("Ext.view.BoundList",opts),me.pageSize&&picker.pagingToolbar.on("beforechange",me.onPageChange,me),me.mon(picker,{itemclick:me.onItemClick,refresh:me.onListRefresh,scope:me}),me.mon(picker.getSelectionModel(),{beforeselect:me.onBeforeSelect,beforedeselect:me.onBeforeDeselect,selectionchange:me.onListSelectionChange,scope:me}),me.store.on("load",function(store){0==store.getTotalCount()?(me.allSelectorHidden=!0,0!=me.allSelector&&me.allSelector.setStyle("display","none"),0!=me.noData&&me.noData.setStyle("display","block")):(me.allSelectorHidden=!1,0!=me.allSelector&&me.allSelector.setStyle("display","block"),0!=me.noData&&me.noData.setStyle("display","none"))}),picker},reset:function(){var me=this;me.setValue("")},setValue:function(value){if(this.value=value,!value)return 0!=this.allSelector&&this.allSelector.removeCls("x-boundlist-selected"),this.callParent(arguments);if("string"==typeof value){var me=this,records=[],vals=value.split(",");return""==value?0!=me.allSelector&&me.allSelector.removeCls("x-boundlist-selected"):vals.length==me.store.getCount()&&0!=vals.length&&(0!=me.allSelector?me.allSelector.addCls("x-boundlist-selected"):me.afterExpandCheck=!0),Ext.each(vals,function(val){var record=me.store.getById(parseInt(val));record&&records.push(record)}),me.setValue(records)}return this.callParent(arguments)},getValue:function(){return"object"==typeof this.value?this.value.join(","):this.value},getSubmitValue:function(){return this.getValue()},expand:function(){var me=this,bodyEl,picker,collapseIf;!me.rendered||me.isExpanded||me.isDestroyed?(me.fireEvent("expand",me),me.onExpand()):(bodyEl=me.bodyEl,picker=me.getPicker(),collapseIf=me.collapseIf,picker.show(),me.isExpanded=!0,me.alignPicker(),bodyEl.addCls(me.openCls),0==me.noData&&(me.noData=picker.getEl().down(".x-boundlist-list-ct").insertHtml("beforeBegin",'<div class="x-boundlist-item" role="option">'+me.noDataText+"</div>",!0)),1==me.addAllSelector&&0==me.allSelector&&(me.allSelector=picker.getEl().down(".x-boundlist-list-ct").insertHtml("beforeBegin",'<div class="x-boundlist-item" role="option"><span class="x-combo-checker">&nbsp;</span> '+me.allText+"</div>",!0),me.allSelector.on("click",function(e){if(me.allSelector.hasCls("x-boundlist-selected"))me.allSelector.removeCls("x-boundlist-selected"),me.setValue(""),me.fireEvent("select",me,[]);else{var records=[];me.store.each(function(record){records.push(record)}),me.allSelector.addCls("x-boundlist-selected"),me.select(records),me.fireEvent("select",me,records)}}),1==me.allSelectorHidden?me.allSelector.hide():me.allSelector.show(),1==me.afterExpandCheck&&(me.allSelector.addCls("x-boundlist-selected"),me.afterExpandCheck=!1)),me.mon(Ext.getDoc(),{mousewheel:collapseIf,mousedown:collapseIf,scope:me}),Ext.EventManager.onWindowResize(me.alignPicker,me),me.fireEvent("expand",me),me.onExpand())},alignPicker:function(){var me=this,picker=me.getPicker();if(me.callParent(),1==me.addAllSelector){var height=picker.getHeight();height=parseInt(height)+20,picker.setHeight(height),picker.getEl().setStyle("height",height+"px")}},onListSelectionChange:function(list,selectedRecords){var me=this,isMulti=me.multiSelect,hasRecords=selectedRecords.length>0;!me.ignoreSelection&&me.isExpanded&&(isMulti||Ext.defer(me.collapse,1,me),(isMulti||hasRecords)&&me.setValue(selectedRecords,!1),hasRecords&&me.fireEvent("select",me,selectedRecords),me.inputEl.focus(),1==me.addAllSelector&&0!=me.allSelector&&(selectedRecords.length==me.store.getTotalCount()?me.allSelector.addCls("x-boundlist-selected"):me.allSelector.removeCls("x-boundlist-selected")))}});
                Ext.define("MyBurnCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){var metrics=[{field:"LeafStoryPlanEstimateTotal",as:"Planned Points",display:"line",f:"sum"},{field:"CalcPreliminaryEstimate",as:"PreliminaryEstimate",display:"line",f:"sum"},{field:"AcceptedLeafStoryPlanEstimateTotal",as:"Accepted Points",display:"line",f:"sum"},{field:"ObjectID",as:"Count",display:"column",f:"count"},{field:"Completed",as:"Completed",display:"column",f:"sum"}];return metrics},getDerivedFieldsOnInput:function(){return[{as:"CalcPreliminaryEstimate",f:function(row){var r=_.find(app.peRecords,function(rec){return rec.get("ObjectID")==row.PreliminaryEstimate});return void 0!==r?r.get("Value"):0}},{as:"Completed",f:function(row){return 1==row.PercentDoneByStoryCount?1:0}}]},getDerivedFieldsAfterSummary:function(){return[{as:"Projection",f:function(row,index,summaryMetrics,seriesData){if(0===index){datesData=_.pluck(seriesData,"label");var today=new Date,li=datesData.length-1;acceptedData=_.pluck(seriesData,"Accepted Points"),acceptedData=_.filter(acceptedData,function(d,i){return today>new Date(Date.parse(datesData[i]))})}var y=linearProject(acceptedData,index);return Math.round(100*y)/100}}]},defined:function(v){return!_.isUndefined(v)&&!_.isNull(v)}});
                function LineFitter(){this.count=0,this.sumX=0,this.sumX2=0,this.sumXY=0,this.sumY=0}function linearProject(data,x){for(var fitter=new LineFitter,i=0;data.length>i;i++)fitter.add(i,data[i]);return fitter.project(x)}function projectToZero(data,x){for(var start=x;linearProject(data,start)>0;)start+=1;return start}LineFitter.prototype={add:function(x,y){this.count++,this.sumX+=x,this.sumX2+=x*x,this.sumXY+=x*y,this.sumY+=y},project:function(x){var det=this.count*this.sumX2-this.sumX*this.sumX,offset=(this.sumX2*this.sumY-this.sumX*this.sumXY)/det,scale=(this.count*this.sumXY-this.sumX*this.sumY)/det;return offset+x*scale}};
                function getReleaseTimeBox(app){var timeboxScope=app.getContext().getTimeboxScope(),tbName=null;if(timeboxScope){var record=timeboxScope.getRecord();tbName=record.get("Name")}else tbName="";return tbName}

            Rally.launchApp('CustomApp', {
                name:"psi-feature-burnup",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

/* check combo */ 
.x-combo-checker { background-position: 50% -2px; margin-left: 1px; background-color: transparent; background-image: url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/unchecked.gif"); background-position: -1px -1px; background-repeat: no-repeat; height: 14px; width: 14px; display: inline-block; } 
.x-boundlist-selected .x-combo-checker { background-image: url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/checked.gif"); }


    </style>
</head>
<body></body>
</html>
