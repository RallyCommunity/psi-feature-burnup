<!DOCTYPE html>
<html>
<head>
    <title>psi-feature-burnup</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var acceptedPointsData=[],acceptedCountData=[],myMask=null,app=null,showAssignedProgram=!0;Ext.define("CustomApp",{scopeType:"release",extend:"Rally.app.App",componentCls:"app",layout:"column",config:{defaultSettings:{releases:"",pointsOrCount:"Points"}},getSettingsFields:function(){return[{name:"releases",xtype:"rallytextfield",label:"Release names to be included (comma seperated)"},{name:"pointsOrCount",xtype:"rallytextfield",label:"Points or Count"}]},launch:function(){if(console.log("Launch"),app=this,app.configReleases=app.getSetting("releases"),app.configPointsOrCount=app.getSetting("pointsOrCount"),""===app.configReleases)return this.add({html:"Please Configure this app by selecting Edit App Settings from Configure (gear) Menu"}),void 0;var that=this;this.project=this.getContext().getProject().ObjectID;var tbName=getReleaseTimeBox(this);app.configReleases=""!==tbName?tbName:app.configReleases;var configs=[];configs.push({model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]}),configs.push({model:"Release",fetch:["Name","ObjectID","Project","ReleaseStartDate","ReleaseDate"],filters:[app.createReleaseFilter(app.configReleases)]}),async.map(configs,this.wsapiQuery,function(err,results){app.peRecords=results[0],app.releases=results[1],configs=[{model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:app.createIterationFilter(app.releases)}],async.map(configs,this.wsapiQuery,function(err,results){app.iterations=results[0],console.log("peRecords:",app.peRecords),console.log("releases:",app.releases),console.log("iterations:",app.iterations),app.queryFeatures()})})},trimString:function(str){return str.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},createReleaseFilter:function(releaseNames){var filter=null;return _.each(releaseNames.split(","),function(releaseName,i){if(""!==releaseName){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"=",value:app.trimString(releaseName)});filter=0===i?f:filter.or(f)}}),console.log("Release Filter:",""+filter),filter},createIterationFilter:function(releases){var extent=app.getReleaseExtent(releases),filter=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:">=",value:extent.isoStart});return filter=filter.and(Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:extent.isoEnd}))},getReleaseExtent:function(releases){var start=_.min(_.pluck(releases,function(r){return r.get("ReleaseStartDate")})),end=_.max(_.pluck(releases,function(r){return r.get("ReleaseDate")})),isoStart=Rally.util.DateTime.toIsoString(start,!1),isoEnd=Rally.util.DateTime.toIsoString(end,!1);return{start:start,end:end,isoStart:isoStart,isoEnd:isoEnd}},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},queryFeatures:function(){myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."});var filter=null;return _.each(app.releases,function(release,i){var f=Ext.create("Rally.data.QueryFilter",{property:"Release",operator:"=",value:release.get("_ref")});filter=0===i?f:filter.or(f)}),Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"PortfolioItem/Feature",limit:"Infinity",fetch:["ObjectID","FormattedID"],filters:[filter],listeners:{load:function(store,features){console.log("Loaded:"+features.length," Features."),app.features=features,app.queryFeatureSnapshots()}}})},queryFeatureSnapshots:function(){var ids=_.pluck(app.features,function(feature){return feature.get("ObjectID")}),extent=app.getReleaseExtent(app.releases),storeConfig={find:{_TypeHierarchy:{$in:["PortfolioItem/Feature"]},ObjectID:{$in:ids},_ValidTo:{$gte:extent.isoStart}},autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:["_UnformattedID","ObjectID","_TypeHierarchy","PreliminaryEstimate","LeafStoryCount","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","AcceptedLeafStoryCount","PercentDoneByStoryCount"],hydrate:["_TypeHierarchy"]};storeConfig.listeners={scope:this,load:function(store,snapshots,success){console.log("Loaded:"+snapshots.length," Snapshots."),app.createChartData(snapshots)}};var snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},createChartData:function(snapshots){var that=this,lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(snapshots,function(d){return d.data}),extent=app.getReleaseExtent(app.releases),snaps=_.sortBy(snapShotData,"_UnformattedID"),holidays=[],myCalc=Ext.create("MyBurnCalculator"),config={deriveFieldsOnInput:myCalc.getDerivedFieldsOnInput(),metrics:myCalc.getMetrics(),summaryMetricsConfig:[],deriveFieldsAfterSummary:myCalc.getDerivedFieldsAfterSummary(),granularity:lumenize.Time.DAY,tz:"America/Chicago",holidays:holidays,workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday"},startOnISOString=new lumenize.Time(extent.start).getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time(extent.end).getISOStringInTZ(config.tz);calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"label"},this.pointsUnitType()?{name:"Planned Points"}:{name:"Planned Count"},{name:"PreliminaryEstimate"},this.pointsUnitType()?{name:"Accepted Points"}:{name:"Accepted Count"},this.pointsUnitType()?{name:"ProjectionPoints"}:{name:"ProjectionCount"},{name:"Count",type:"column"},{name:"Completed",type:"column"}],hc=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig);this.showChart(hc)},createPlotLines:function(seriesData){var start=new Date(Date.parse(seriesData[0])),end=new Date(Date.parse(seriesData[seriesData.length-1])),releaseI=_.filter(this.iterations,function(i){return i.get("EndDate")>=start&&end>=i.get("EndDate")});releaseI=_.uniq(releaseI,function(i){return i.get("Name")});var itPlotLines=_.map(releaseI,function(i){var d=new Date(Date.parse(i.raw.EndDate)).toISOString().split("T")[0];return{label:i.get("Name"),dashStyle:"Dot",color:"grey",width:1,value:_.indexOf(seriesData,d)}}),rePlotLines=_.map(this.selectedReleases,function(i){var d=new Date(Date.parse(i.raw.ReleaseDate)).toISOString().split("T")[0];return{label:i.get("Name"),color:"grey",width:1,value:_.indexOf(seriesData,d)}});return itPlotLines.concat(rePlotLines)},showChart:function(series){var that=this,chart=this.down("#chart1");myMask.hide(),null!==chart&&chart.removeAll();var plotlines=this.createPlotLines(series[0].data),tickInterval=140>=series[1].data.length?7:series[1].data.length/20,extChart=Ext.create("Rally.ui.chart.Chart",{columnWidth:1,itemId:"chart1",chartData:{categories:series[0].data,series:series.slice(1,series.length)},chartColors:["Gray","Orange","Green","LightGray","Blue","Green"],chartConfig:{chart:{},title:{text:"PSI Feature Burnup",x:-20},plotOptions:{series:{marker:{radius:2}}},xAxis:{plotLines:plotlines,tickInterval:tickInterval,type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%b %d",Date.parse(this.value))}}},yAxis:{title:{text:that.pointsUnitType()?"Points":"Count"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{},legend:{align:"center",verticalAlign:"bottom"}}});this.add(extChart),chart=this.down("#chart1");var p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})},pointsUnitType:function(){return"Points"===app.configPointsOrCount}});
                Ext.define("MyBurnCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",pointsOffset:0,countOffset:0,getMetrics:function(){var metrics=[{field:"LeafStoryCount",as:"Planned Count",display:"line",f:"sum"},{field:"LeafStoryPlanEstimateTotal",as:"Planned Points",display:"line",f:"sum"},{field:"CalcPreliminaryEstimate",as:"PreliminaryEstimate",display:"line",f:"sum"},{field:"AcceptedLeafStoryPlanEstimateTotal",as:"Accepted Points",display:"line",f:"sum"},{field:"AcceptedLeafStoryCount",as:"Accepted Count",display:"line",f:"sum"},{field:"ObjectID",as:"Count",display:"column",f:"count"},{field:"Completed",as:"Completed",display:"column",f:"sum"}];return metrics},getDerivedFieldsOnInput:function(){return[{as:"CalcPreliminaryEstimate",f:function(row){var r=_.find(app.peRecords,function(rec){return rec.get("ObjectID")==row.PreliminaryEstimate});return void 0!==r?r.get("Value"):0}},{as:"Completed",f:function(row){return 1==row.PercentDoneByStoryCount?1:0}}]},getDerivedFieldsAfterSummary:function(){return[{as:"ProjectionPoints",f:function(row,index,summaryMetrics,seriesData){var that=this;if(0===index){datesData=_.pluck(seriesData,"label");var today=new Date,li=datesData.length-1;acceptedPointsData=_.pluck(seriesData,"Accepted Points"),acceptedPointsData=_.filter(acceptedPointsData,function(d,i){return today>new Date(Date.parse(datesData[i]))});var lastAccepted=acceptedPointsData[acceptedPointsData.length-1],lastProjected=linearProject(acceptedPointsData,acceptedPointsData.length-1);console.log("last accepted:",lastAccepted,"last projected:",lastProjected),that.pointsOffset=lastAccepted-lastProjected}var y=linearProject(acceptedPointsData,index)+that.pointsOffset;return Math.round(100*y)/100}},{as:"ProjectionCount",f:function(row,index,summaryMetrics,seriesData){var that=this;if(0===index){datesData=_.pluck(seriesData,"label");var today=new Date,li=datesData.length-1;acceptedCountData=_.pluck(seriesData,"Accepted Count"),acceptedCountData=_.filter(acceptedCountData,function(d,i){return today>new Date(Date.parse(datesData[i]))});var lastAccepted=acceptedCountData[acceptedCountData.length-1],lastProjected=linearProject(acceptedCountData,acceptedCountData.length-1);console.log("last accepted:",lastAccepted,"last projected:",lastProjected),that.countOffset=lastAccepted-lastProjected}var y=linearProject(acceptedCountData,index)+that.countOffset;return Math.round(100*y)/100}}]},defined:function(v){return!_.isUndefined(v)&&!_.isNull(v)}});
                function LineFitter(){this.count=0,this.sumX=0,this.sumX2=0,this.sumXY=0,this.sumY=0}function linearProject(data,x){for(var fitter=new LineFitter,i=0;data.length>i;i++)fitter.add(i,data[i]);return fitter.project(x)}function projectToZero(data,x){for(var start=x;linearProject(data,start)>0;)start+=1;return start}LineFitter.prototype={add:function(x,y){this.count++,this.sumX+=x,this.sumX2+=x*x,this.sumXY+=x*y,this.sumY+=y},project:function(x){var det=this.count*this.sumX2-this.sumX*this.sumX,offset=(this.sumX2*this.sumY-this.sumX*this.sumXY)/det,scale=(this.count*this.sumXY-this.sumX*this.sumY)/det;return offset+x*scale}};
                function getReleaseTimeBox(app){var timeboxScope=app.getContext().getTimeboxScope(),tbName=null;if(timeboxScope){var record=timeboxScope.getRecord();tbName=record.get("Name")}else tbName="";return tbName}function wsapiQuery(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}function snapshotQuery(config,callback){var storeConfig={find:config.find,fetch:config.fetch,hydrate:config.hydrate,autoLoad:!0,pageSize:1e4,limit:"Infinity",listeners:{scope:this,load:function(store,snapshots,success){console.log("snapshots:",snapshots.length),callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)}function pointsUnitType(type){return"Points"==type}

            Rally.launchApp('CustomApp', {
                name:"psi-feature-burnup",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

/* check combo */ 
.x-combo-checker { background-position: 50% -2px; margin-left: 1px; background-color: transparent; background-image: url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/unchecked.gif"); background-position: -1px -1px; background-repeat: no-repeat; height: 14px; width: 14px; display: inline-block; } 
.x-boundlist-selected .x-combo-checker { background-image: url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/checked.gif"); }


    </style>
</head>
<body></body>
</html>
