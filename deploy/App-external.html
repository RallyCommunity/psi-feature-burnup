<!DOCTYPE html>
<html>
<head>
    <title>psi-feature-burnup</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{scopeType:"release",extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:{useCurrentRelease:!0,releases:"",parentIds:"",parentType:"",parentQuery:"",ignoreZeroValues:!0,PreliminaryEstimate:!0,StoryPoints:!0,StoryCount:!1,StoryPointsProjection:!0,StoryCountProjection:!1,AcceptedStoryPoints:!0,AcceptedStoryCount:!1,AcceptedPointsProjection:!0,AcceptedCountProjection:!1,FeatureCount:!1,FeatureCountCompleted:!1,HistoricalProjection:!1,RefinedEstimate:!1}},getSettingsFields:function(){var checkValues=_.map(createSeriesArray(),function(s){return{name:s.name,xtype:"rallycheckboxfield",label:s.description}}),values=[{name:"useCurrentRelease",xtype:"rallycheckboxfield",label:"Checked to chart the current release"},{name:"releases",xtype:"rallytextfield",label:"(Optional) Release names to be included (comma seperated)"},{name:"parentIds",xtype:"rallytextfield",label:"(Optional) List of Parent PortfolioItem (Epics) ids to filter Features by"},{name:"parentType",xtype:"rallytextfield",label:"(Optional) Type of Parent PortfolioItem to apply filter below"},{name:"parentQuery",xtype:"rallytextfield",width:600,fieldLabel:"(Optional) Limit to items that currently meet this query:"},{name:"ignoreZeroValues",xtype:"rallycheckboxfield",label:"For projection ignore zero values"}];return _.each(values,function(value){value.labelWidth=250,value.labelAlign="left"}),values.concat(checkValues)},launch:function(){if(app=this,app.series=createSeriesArray(),app.useCurrentRelease=app.getSetting("useCurrentRelease"),app.configReleases=app.getSetting("releases"),app.ignoreZeroValues=app.getSetting("ignoreZeroValues"),app.parentIds=app.getSetting("parentIds"),app.parentQueryType=app.getSetting("parentType"),app.parentQuery=app.getSetting("parentQuery"),app.title="Feature Burnup",app.useCurrentRelease===!1&&""===app.configReleases&&""===app.parentIds&&""===app.parentQueryType&&""===app.parentQuery)return this.add({html:"Please Configure this app by selecting Edit App Settings from Configure (gear) Menu"}),void 0;var that=this;this.project=this.getContext().getProject().ObjectID;var tbName=getReleaseTimeBox(this);app.configReleases=""!==tbName?tbName:app.configReleases;var releaseFilter=app.useCurrentRelease?app.currentReleaseFilter():app.createReleaseFilter(app.configReleases),configs=[];configs.push({model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]}),configs.push({model:"Release",fetch:["Name","ObjectID","Project","ReleaseStartDate","ReleaseDate"],filters:null!==releaseFilter?[releaseFilter]:[]}),configs.push({model:"TypeDefinition",fetch:!0,filters:[{property:"Ordinal",operator:"=",value:0}]}),async.map(configs,app.wsapiQuery,function(err,results){if(app.peRecords=results[0],app.releases=results[1],app.featureType=results[2][0].get("TypePath"),""!==app.parentQueryType&&""!==app.parentQuery){var strategy=Ext.create("FeaturesForPortfolioQueryStrategy",{featureType:app.featureType,parentQueryType:"PortfolioItem/"+app.parentQueryType,parentQuery:app.parentQuery,context:app.getContext()});strategy.readFeatures(function(results,error){return error?(app.add({html:error}),void 0):(myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),console.log("Read features",results.features.length,results.extent,results.iterations.length),app.features=results.features,app.iterations=results.iterations,app.extent=results.extent,app.title=results.title,app.queryFeatureSnapshots(),void 0)})}else if(""!==app.parentIds.split(",")[0]){var strategy=Ext.create("FeaturesForParentStrategy",{portfolioIds:app.parentIds,featureType:app.featureType,context:app.getContext()});strategy.readFeatures(function(results,error){return error?(app.add({html:error}),void 0):(console.log("Read features",results.features.length,results.extent,results.iterations.length),app.features=results.features,app.iterations=results.iterations,app.extent=results.extent,app.title=results.title,app.queryFeatureSnapshots(),void 0)})}else{if(app.extent=app.getReleaseExtent(app.releases),0===app.releases.length)return app.add({html:"No Releases found with this name: "+app.configReleases}),void 0;configs=[{model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:app.createIterationFilter(app.releases)}],async.map(configs,app.wsapiQuery,function(err,results){app.iterations=results[0],app.queryFeatures()})}})},trimString:function(str){return str.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},createReleaseFilter:function(releaseNames){var filter=null;return _.each(releaseNames.split(","),function(releaseName,i){if(""!==releaseName){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"=",value:app.trimString(releaseName)});filter=0===i?f:filter.or(f)}}),console.log("Release Filter:",null!==filter?""+filter:"not set"),filter},currentReleaseFilter:function(){var isoToday=Rally.util.DateTime.toIsoString(new Date,!1),f1=Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseDate",operator:">=",value:isoToday}),f2=Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseStartDate",operator:"<=",value:isoToday}),filter=f1.and(f2);return console.log("Release Filter:",null!==filter?""+filter:"not set"),filter},createIterationFilter:function(releases){var extent=app.getReleaseExtent(releases),filter=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:">=",value:extent.isoStart});return filter=filter.and(Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<=",value:extent.isoEnd}))},getReleaseExtent:function(releases){var start=_.min(_.pluck(releases,function(r){return r.get("ReleaseStartDate")})),end=_.max(_.pluck(releases,function(r){return r.get("ReleaseDate")})),isoStart=Rally.util.DateTime.toIsoString(start,!1),isoEnd=Rally.util.DateTime.toIsoString(end,!1);return{start:start,end:end,isoStart:isoStart,isoEnd:isoEnd}},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},queryEpicFeatures:function(){var filter=null,parentIds=app.parentIds.split(",");return 0===epicIds.length?(app.add({html:"No epic id's specified"+app.configReleases}),void 0):(_.each(epicIds,function(epicId,i){var f=Ext.create("Rally.data.QueryFilter",{property:"Parent.FormattedID",operator:"=",value:epicId});filter=0===i?f:filter.or(f)}),Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:app.featureType,limit:"Infinity",fetch:["ObjectID","FormattedID"],filters:[filter],listeners:{load:function(store,features){return console.log("Loaded:"+features.length," Features."),app.features=features,0===app.features.length?(app.add({html:"No features for parent PortfolioItem :"+app.epicIds}),void 0):(app.queryFeatureSnapshots(),void 0)}}}))},queryFeatures:function(){var filter=null,releaseNames=_.uniq(_.map(app.releases,function(r){return r.get("Name")}));return _.each(releaseNames,function(release,i){var f=Ext.create("Rally.data.QueryFilter",{property:"Release.Name",operator:"=",value:release});filter=0===i?f:filter.or(f)}),Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:app.featureType,limit:"Infinity",fetch:["ObjectID","FormattedID"],filters:[filter],listeners:{load:function(store,features){return console.log("Loaded:"+features.length," Features."),app.features=features,0===app.features.length?(app.add({html:"No features in release(s):"+app.configReleases}),void 0):(app.queryFeatureSnapshots(),void 0)}}})},queryFeatureSnapshots:function(){var ids=_.pluck(app.features,function(feature){return feature.get("ObjectID")}),storeConfig={find:{ObjectID:{$in:ids},_ValidTo:{$gte:app.extent.isoStart}},autoLoad:!0,pageSize:200,limit:"Infinity",fetch:["_UnformattedID","ObjectID","_TypeHierarchy","PreliminaryEstimate","LeafStoryCount","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","AcceptedLeafStoryCount","PercentDoneByStoryCount","RefinedEstimate"],hydrate:["_TypeHierarchy"]};storeConfig.listeners={scope:this,load:function(store,snapshots,success){app.createChartData(snapshots)}};var snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},createChartData:function(snapshots){var that=this,lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(snapshots,function(d){return d.data}),extent=app.getReleaseExtent(app.releases),snaps=_.sortBy(snapShotData,"_UnformattedID"),holidays=[],myCalc=Ext.create("MyBurnCalculator",{series:app.series,ignoreZeroValues:app.ignoreZeroValues,peRecords:app.peRecords}),config={deriveFieldsOnInput:myCalc.getDerivedFieldsOnInput(),metrics:myCalc.getMetrics(),summaryMetricsConfig:[],deriveFieldsAfterSummary:myCalc.getDerivedFieldsAfterSummary(),granularity:lumenize.Time.DAY,tz:"America/Chicago",holidays:holidays,workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday"},startOnISOString=new lumenize.Time(extent.start).getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time(extent.end).getISOStringInTZ(config.tz);calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"label"}];_.each(app.series,function(s){app.getSetting(s.name)===!0&&hcConfig.push({name:s.description,type:s.display})});var hc=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig);this.showChart(trimHighChartsConfig(hc))},createPlotLines:function(seriesData){var start=new Date(Date.parse(seriesData[0])),end=new Date(Date.parse(seriesData[seriesData.length-1])),releaseI=_.filter(this.iterations,function(i){return i.get("EndDate")>=start&&end>=i.get("EndDate")});releaseI=_.uniq(releaseI,function(i){return i.get("Name")});var itPlotLines=_.map(releaseI,function(i){var d=new Date(Date.parse(i.raw.EndDate)).toISOString().split("T")[0];return{label:i.get("Name"),dashStyle:"Dot",color:"grey",width:1,value:_.indexOf(seriesData,d)}}),rePlotLines=_.map(this.selectedReleases,function(i){var d=new Date(Date.parse(i.raw.ReleaseDate)).toISOString().split("T")[0];return{label:i.get("Name"),color:"grey",width:1,value:_.indexOf(seriesData,d)}});return itPlotLines.concat(rePlotLines)},showChart:function(series){var that=this,chart=this.down("#chart1");null!==chart&&chart.removeAll();var plotlines=this.createPlotLines(series[0].data),tickInterval=140>=series[1].data.length?7:series[1].data.length/20,extChart=Ext.create("Rally.ui.chart.Chart",{columnWidth:1,itemId:"chart1",chartData:{categories:series[0].data,series:series.slice(1,series.length)},chartColors:createColorsArray(series),chartConfig:{chart:{},title:{text:app.title,x:-20},plotOptions:{series:{marker:{radius:2}}},xAxis:{plotLines:plotlines,tickInterval:tickInterval,type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%b %d",Date.parse(this.value))}}},yAxis:{title:{text:"Points/Count"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{},legend:{align:"center",verticalAlign:"bottom"}}});this.add(extChart),chart=this.down("#chart1");var p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})}});
                Ext.define("MyBurnCalculator",function(){var self;return{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{series:[],ignoreZeroValues:!0,peRecords:[]},constructor:function(config){return self=this,this.initConfig(config),this},pointsOffset:[],countOffset:[],data:[],indexOffset:[],getMetrics:function(){var nonProjectionMetrics=_.filter(self.series,function(s){return-1==s.name.indexOf("Projection")}),metrics=_.map(nonProjectionMetrics,function(m){return{field:m.field,as:m.description,display:m.display,f:m.f}});return metrics},getDerivedFieldsOnInput:function(){return[{as:"CalcPreliminaryEstimate",f:function(row){var r=_.find(self.peRecords,function(rec){return rec.get("ObjectID")==row.PreliminaryEstimate}),v=void 0!==r?r.get("Value"):0;return v}},{as:"Completed",f:function(row){return 1==row.PercentDoneByStoryCount?1:0}}]},getMidPointIndex:function(dateSeries){var today=new Date,tdi=_.findIndex(dateSeries,function(d){return today.setHours(0,0,0,0)===new Date(Date.parse(d)).setHours(0,0,0,0)});return-1!==tdi?Math.round(tdi/2):-1},calcProjectionPoint:function(seriesName,projectOn,row,index,summaryMetrics,seriesData,projectFrom){var that=this;if(0===index){datesData=_.pluck(seriesData,"label");var mid=self.getMidPointIndex(datesData),today=new Date,li=datesData.length-1;that.data[seriesName]=_.pluck(seriesData,projectOn),that.data[seriesName]=_.filter(that.data[seriesName],function(d,i){return _.isUndefined(projectFrom)||"mid"!==projectFrom?today>new Date(Date.parse(datesData[i])):mid>i});var dx=that.data[seriesName].length;self.ignoreZeroValues===!0&&(that.data[seriesName]=_.filter(that.data[seriesName],function(d,i){return 0!==d&&null!==d}));var dy=that.data[seriesName].length;that.indexOffset[seriesName]=dx-dy;var lastAccepted=that.data[seriesName][that.data[seriesName].length-1],lastProjected=linearProject(that.data[seriesName],that.data[seriesName].length-1);that.pointsOffset[seriesName]=lastAccepted-lastProjected}index-=that.indexOffset[seriesName];var y=linearProject(that.data[seriesName],index)+that.pointsOffset[seriesName];return Math.round(100*y)/100},getDerivedFieldsAfterSummary:function(){var projectionMetrics=_.filter(self.series,function(s){return-1!==s.name.indexOf("Projection")}),metrics=_.map(projectionMetrics,function(m){return{as:m.description,projectOn:m.projectOn,projectFrom:m.projectFrom,name:m.name,f:function(row,index,summaryMetrics,seriesData){var p=self.calcProjectionPoint(this.name,this.projectOn,row,index,summaryMetrics,seriesData,this.projectFrom);return p}}});return metrics},defined:function(v){return!_.isUndefined(v)&&!_.isNull(v)}}});
                function LineFitter(){this.count=0,this.sumX=0,this.sumX2=0,this.sumXY=0,this.sumY=0}function linearProject(data,x){for(var fitter=new LineFitter,i=0;data.length>i;i++)fitter.add(i,data[i]);return fitter.project(x)}function projectToZero(data,x){for(var start=x;linearProject(data,start)>0;)start+=1;return start}LineFitter.prototype={add:function(x,y){this.count++,this.sumX+=x,this.sumX2+=x*x,this.sumXY+=x*y,this.sumY+=y},project:function(x){var det=this.count*this.sumX2-this.sumX*this.sumX,offset=(this.sumX2*this.sumY-this.sumX*this.sumXY)/det,scale=(this.count*this.sumXY-this.sumX*this.sumY)/det;return offset+x*scale}};
                function getReleaseTimeBox(app){var timeboxScope=app.getContext().getTimeboxScope(),tbName=null;if(timeboxScope){var record=timeboxScope.getRecord();tbName=record.get("Name")}else tbName="";return tbName}function wsapiQuery(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}function snapshotQuery(config,callback){var storeConfig={find:config.find,fetch:config.fetch,hydrate:config.hydrate,autoLoad:!0,pageSize:200,limit:"Infinity",listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)}function pointsUnitType(type){return"Points"==type}function createSeriesArray(){return[{name:"PreliminaryEstimate",description:"Preliminary Estimate",field:"CalcPreliminaryEstimate",display:"line",f:"sum",color:"Orange"},{name:"StoryPoints",description:"Story Points",field:"LeafStoryPlanEstimateTotal",display:"line",f:"sum",color:"DarkGray"},{name:"StoryCount",description:"Story Count",field:"LeafStoryCount",display:"line",f:"sum",color:"DarkGray"},{name:"StoryPointsProjection",description:"Scope Projection",projectOn:"Story Points",color:"LightGray"},{name:"StoryCountProjection",description:"Count Projection",projectOn:"Story Count",color:"LightGray"},{name:"AcceptedStoryPoints",description:"Accepted Points",field:"AcceptedLeafStoryPlanEstimateTotal",display:"line",f:"sum",color:"Green"},{name:"AcceptedStoryCount",description:"Accepted Count",field:"AcceptedLeafStoryCount",display:"line",f:"sum",color:"Green"},{name:"AcceptedPointsProjection",description:"Accepted Projection",projectOn:"Accepted Points",color:"LightGray"},{name:"AcceptedCountProjection",description:"Accepted Count Projection",projectOn:"Accepted Count",color:"LightGray"},{name:"FeatureCount",description:"Feature Count",field:"ObjectID",display:"column",f:"count",color:"Blue"},{name:"FeatureCountCompleted",description:"Completed Feature Count",field:"Completed",display:"column",f:"sum",color:"Green"},{name:"HistoricalProjection",description:"Historical Trend Projection",projectOn:"Accepted Points",color:"LightGray",hidden:!0,projectFrom:"mid"},{name:"RefinedEstimate",description:"Refined Feature Estimate",field:"RefinedEstimate",display:"line",f:"sum",color:"DarkBlue"}]}function createColorsArray(series){var colors=[];return _.each(series,function(s,i){if(i>0){var as=_.find(app.series,function(a){return a.description===s.name});_.isUndefined(as)?colors.push("LightGray"):colors.push(as.color)}}),colors}function trimHighChartsConfig(hc){var today=new Date;return _.each(hc,function(series,i){-1===series.name.indexOf("Projection")&&-1===series.name.indexOf("label")&&_.each(series.data,function(point,x){Date.parse(hc[0].data[x])>today&&(series.data[x]=null)}),-1!==series.name.indexOf("Projection")&&(_.each(series.data,function(point,x){today>Date.parse(hc[0].data[x])&&(series.data[x]=null)}),series.dashStyle="dash")}),hc}
                Ext.define("FeaturesForParentStrategy",function(){var self;return{config:{portfolioIds:"",featureType:"",context:""},constructor:function(config){return self=this,this.initConfig(config),self.portfolioIds=_.map(self.piArray(),function(s){return s.trim()}).join(","),this},createTitle:function(parents){var title="Burnup for Portfolio Items ("+_.first(_.map(parents,function(p){return p.get("FormattedID")}),4)+(parents.length>4?"...":"")+")";return title},piArray:function(){return self.portfolioIds.split(",")},readFeatures:function(callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"portfolioitem",limit:"Infinity",fetch:["ObjectID","FormattedID","PlannedStartDate","PlannedEndDate"],filters:[self.createPIFilter(self.piArray(),"FormattedID")],listeners:{load:function(store,parents){parents=_.filter(parents,function(parent){return-1!==_.indexOf(self.portfolioIds.split(","),parent.get("FormattedID"))});var diff=_.difference(self.piArray(),_.map(parents,function(p){return p.get("FormattedID")}));if(diff.length>0)return callback(null,"The following items were not found:"+diff.join(",")),void 0;var extent=self.getPortfolioItemExtent(parents);if(!extent.valid)return callback(null,"At least one of the portfolio items selected must have a planned start and end date set to define the chart date range"),void 0;var parentIds=_.map(parents,function(parent){return parent.get("ObjectID")});self.getIterations(extent,function(iterations){self.findFeatureSnapShots(parentIds,function(snapshots){var featureIds=_.map(snapshots,function(s){return s.get("ObjectID")}),error=featureIds.length>0?null:"No features found for selected parents:"+self.piArray().join(",");return error?(callback(null,error),void 0):(self.getFeatures(featureIds,function(features){var error=features.length>0?null:"No features found for selected parents:"+self.piArray().join(",");callback({features:features,extent:extent,iterations:iterations,title:self.createTitle(parents)},error)}),void 0)})})}}})},createIterationFilter:function(extent){var filter=null,f1=Ext.create("Rally.data.QueryFilter",{property:"StartDate",operator:">=",value:extent.isoStart}),f2=Ext.create("Rally.data.QueryFilter",{property:"EndDate",operator:"<=",value:extent.isoEnd}),filter=f1.and(f2);return filter},createPIFilter:function(ids,field){var filter=null,idsArray=_.isArray(ids)?ids:ids.split(",");return _.each(idsArray,function(id,i){var f=Ext.create("Rally.data.QueryFilter",{property:field,operator:"=",value:id});filter=0===i?f:filter.or(f)}),filter},findFeatureSnapShots:function(parentIds,callback){var storeConfig={find:{_TypeHierarchy:{$in:[self.featureType]},_ItemHierarchy:{$in:parentIds},__At:"current"},autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:["ObjectID","_TypeHierarchy"],hydrate:["_TypeHierarchy"],listeners:{scope:this,load:function(store,snapshots,success){callback(snapshots)}}};Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},getPortfolioItemExtent:function(items){var startDates=_.compact(_.pluck(items,function(r){return r.get("PlannedStartDate")})),endDates=_.compact(_.pluck(items,function(r){return r.get("PlannedEndDate")})),valid=startDates.length>0&&endDates.length>0,start=_.min(startDates),end=_.max(endDates),isoStart=Rally.util.DateTime.toIsoString(start,!1),isoEnd=Rally.util.DateTime.toIsoString(end,!1);return{start:start,end:end,isoStart:isoStart,isoEnd:isoEnd,valid:valid}},getIterations:function(extent,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"Iteration",limit:"Infinity",fetch:["ObjectID","EndDate","StartDate","Name"],filters:[self.createIterationFilter(extent)],listeners:{load:function(store,iterations){callback(iterations)}}})},getFeatures:function(featureIds,callback){var filter=self.createPIFilter(featureIds,"ObjectID");Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:self.featureType,limit:"Infinity",fetch:["ObjectID","FormattedID"],filters:[filter],listeners:{load:function(store,features){callback(features)}}})}}});
                Ext.define("FeaturesForPortfolioQueryStrategy",function(){var self;return{extend:"FeaturesForParentStrategy",config:{featureType:"",parentQueryType:"",parentQuery:"",context:""},constructor:function(config){return self=this,this.initConfig(config),this.callParent([this.config]),this},readFeatures:function(callback){self.getParents(self.parentQueryType,self.parentQuery,function(parents,error){var oids=_.map(parents,function(i){return i.get("ObjectID")});self.findFeatureSnapShots(oids,function(snapshots){var featureIds=_.map(snapshots,function(s){return s.get("ObjectID")});return 0===snapshots.length?(callback(null,"No features found for selected parents"),void 0):(self.getFeatures(featureIds,function(features){var extent=self.getPortfolioItemExtent(parents);return extent.valid?(self.getIterations(extent,function(iterations){callback({features:features,extent:extent,iterations:iterations,title:self.createTitle(parents)},error)}),void 0):(callback(null,"At least one of the portfolio items selected must have a planned start and end date set to define the chart date range"),void 0)}),void 0)})})},getParents:function(parentType,parentQuery,callback){var filter=Ext.create("TSStringFilter",{query_string:parentQuery});Ext.create("Rally.data.WsapiDataStore",{model:parentType,autoLoad:!0,limit:"Infinity",filters:filter,fetch:["FormattedID","ObjectID","PlannedStartDate","PlannedEndDate"],listeners:{scope:this,load:function(store,items,successful,opts){successful?callback(items):callback(null,"Error loading filter")}}})}}});
                Ext.define("TSStringFilter",{extend:"Rally.data.QueryFilter",config:{query_string:""},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},_createQueryString:function(property,operator,value){return this.filter=this.fromQueryString(this.query_string),""+this.filter},fromQueryString:function(query){var parser=Ext.create("Rally.data.util.QueryStringParser",{string:query}),initial_expression=parser.parseExpression();return initial_expression}});

            Rally.launchApp('CustomApp', {
                name:"psi-feature-burnup",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-combo-checker{background-position:50% -2px;margin-left:1px;background-color:transparent;background-image:url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/unchecked.gif");background-position:-1px -1px;background-repeat:no-repeat;height:14px;width:14px;display:inline-block}.x-boundlist-selected .x-combo-checker{background-image:url("https://rally1.rallydev.com/apps/2.0rc1/lib/ext/4.1.1a/resources/themes/images/default/grid/checked.gif")}
    </style>
</head>
<body>
</body>
</html>
