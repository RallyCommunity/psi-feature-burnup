<!DOCTYPE html>
<html>
<head>
    <title>tagged-feature-burnup</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{},launch:function(){var workspace=this.getContext().getWorkspace();return Rally.data.ModelFactory.getModel({type:"Workspace",success:function(model){model.load(workspace.ObjectID,{fetch:!0,callback:function(result,operation){operation.wasSuccessful()&&console.log("workspace result",result)}})}}),app=this,app.series=createSeriesArray(),console.log("series",app.series),app.itemtype=app.getSetting("itemtype"),app.tags=app.getSetting("tags").split(","),console.log(app.tags),app.title="Portfolio Item burnup for tags '"+app.tags+"'",""===app.tags[0]?(console.log("No Tags specified in configuration"),app.add({html:"No Tags specied. Edit the app setting to set Tags to filter on"}),void 0):(app.mask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.mask.show(),async.waterfall([app.queryEstimateValues,app.queryFeatures,app.getStartAndEndDates,app.querySnapshots,app.lumenize,app.showChart],function(err,results){null!==err&&app.add({html:err}),console.log("done!"),app.mask.hide()}),void 0)},config:{defaultSettings:{itemtype:"Feature",tags:"",ignoreZeroValues:!0,PreliminaryEstimate:!0,StoryPoints:!1,StoryCount:!0,StoryPointsProjection:!1,StoryCountProjection:!0,AcceptedStoryPoints:!1,AcceptedStoryCount:!0,AcceptedPointsProjection:!1,AcceptedCountProjection:!0,FeatureCount:!1,FeatureCountCompleted:!1}},getSettingsFields:function(){var checkValues=_.map(createSeriesArray(),function(s){return{name:s.name,xtype:"rallycheckboxfield",label:s.description}});return[{name:"itemtype",xtype:"rallytextfield",label:"Portfolio Item Type eg. Feature"},{name:"tags",xtype:"rallytextfield",label:"Comma separated list of tags eg. tag1,tag2,tag3"},{name:"ignoreZeroValues",xtype:"rallycheckboxfield",label:"For projection ignore zero values"}].concat(checkValues)},queryEstimateValues:function(callback){var configs=[];configs.push({model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[]}),async.map(configs,wsapiQuery,function(err,results){console.log("Estimates",results[0]),app.peRecords=results[0],callback(null)})},queryFeatures:function(callback){console.log("queryFeatures");var configs=[],filter=null;_.each(app.tags,function(tag,i){var f=Ext.create("Rally.data.QueryFilter",{property:"Tags.Name",operator:"=",value:tag});filter=0===i?f:filter.or(f)}),configs.push({model:"PortfolioItem/"+app.itemtype,fetch:["Name","ObjectID","PlannedStartDate","PlannedEndDate"],filters:[filter]}),async.map(configs,wsapiQuery,function(err,results){console.log("Features:",results[0]),callback(null,results[0])})},getStartAndEndDates:function(features,callback){var startdates=_.compact(_.pluck(features,function(r){return r.get("PlannedStartDate")})),enddates=_.compact(_.pluck(features,function(r){return r.get("PlannedEndDate")}));app.startdate=_.min(startdates),app.enddate=_.max(enddates),app.isoStartDate=Rally.util.DateTime.toIsoString(app.startdate,!1),app.isoEndDate=Rally.util.DateTime.toIsoString(app.enddate,!1),console.log("start",app.startdate,"end",app.enddate),console.log(_.isFinite(app.startdate),_.isFinite(app.enddate)),app.infinity(app.startdate)||app.infinity(app.enddate)?callback("Could not determine start or end date from Tagged portfolio items",null):callback(null,features)},infinity:function(val){return 1/0===val||val===-1/0},querySnapshots:function(features,callback){var config={};config.fetch=["_UnformattedID","ObjectID","_TypeHierarchy","PreliminaryEstimate","LeafStoryCount","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal","AcceptedLeafStoryCount","PercentDoneByStoryCount"],config.hydrate=["_TypeHierarchy"],config.find={ObjectID:{$in:_.pluck(features,function(f){return f.get("ObjectID")})},_ValidFrom:{$gte:app.isoStartDate}},async.map([config],snapshotQuery,function(error,results){callback(null,results[0])})},lumenize:function(snapshots,callback){var lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(snapshots,function(d){return d.data}),holidays=[],myCalc=Ext.create("MyBurnCalculator",{series:app.series,ignoreZeroValues:app.ignoreZeroValues,peRecords:app.peRecords}),config={deriveFieldsOnInput:myCalc.getDerivedFieldsOnInput(),metrics:myCalc.getMetrics(),summaryMetricsConfig:[],deriveFieldsAfterSummary:myCalc.getDerivedFieldsAfterSummary(),granularity:lumenize.Time.DAY,tz:"America/New_York",holidays:holidays,workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday"},startOnISOString=new lumenize.Time(app.startdate).getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time(app.enddate).getISOStringInTZ(config.tz);calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"label"}];_.each(app.series,function(s){app.getSetting(s.name)===!0&&hcConfig.push({name:s.description,type:s.display})});var hc=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig);console.log("hc",hc),callback(null,trimHighChartsConfig(hc))},showChart:function(series,callback){var chart=app.down("#chart1");null!==chart&&chart.removeAll();var tickInterval=140>=series[1].data.length?7:series[1].data.length/20,colors=createColorsArray(series),extChart=Ext.create("Rally.ui.chart.Chart",{columnWidth:1,itemId:"chart1",listeners:{afterrender:function(){console.log("rendered"),callback(null,null)}},chartData:{categories:series[0].data,series:series.slice(1,series.length)},chartColors:colors,chartConfig:{chart:{},title:{text:app.title,x:-20},plotOptions:{series:{marker:{radius:2}}},xAxis:{tickInterval:tickInterval,type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%b %d",Date.parse(this.value))}}},yAxis:{title:{text:"Points\\Count"},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{},legend:{align:"center",verticalAlign:"bottom"}}});app.add(extChart),chart=app.down("#chart1");var p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})}});
                Ext.define("MyBurnCalculator",function(){var self;return{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{series:[],ignoreZeroValues:!0,peRecords:[]},constructor:function(config){return self=this,this.initConfig(config),this},pointsOffset:[],countOffset:[],data:[],indexOffset:[],getMetrics:function(){var nonProjectionMetrics=_.filter(self.series,function(s){return-1==s.name.indexOf("Projection")}),metrics=_.map(nonProjectionMetrics,function(m){return{field:m.field,as:m.description,display:m.display,f:m.f}});return metrics},getDerivedFieldsOnInput:function(){return[{as:"CalcPreliminaryEstimate",f:function(row){var r=_.find(self.peRecords,function(rec){return rec.get("ObjectID")==row.PreliminaryEstimate});return void 0!==r?r.get("Value"):0}},{as:"Completed",f:function(row){return 1==row.PercentDoneByStoryCount?1:0}}]},calcProjectionPoint:function(seriesName,row,index,summaryMetrics,seriesData){var that=this;if(0===index){datesData=_.pluck(seriesData,"label");var today=new Date,li=datesData.length-1;that.data[seriesName]=_.pluck(seriesData,seriesName),that.data[seriesName]=_.filter(that.data[seriesName],function(d,i){return today>new Date(Date.parse(datesData[i]))});var dx=that.data[seriesName].length;self.ignoreZeroValues===!0&&(that.data[seriesName]=_.filter(that.data[seriesName],function(d,i){return 0!==d}));var dy=that.data[seriesName].length;that.indexOffset[seriesName]=dx-dy;var lastAccepted=that.data[seriesName][that.data[seriesName].length-1],lastProjected=linearProject(that.data[seriesName],that.data[seriesName].length-1);that.pointsOffset[seriesName]=lastAccepted-lastProjected}index-=that.indexOffset[seriesName];var y=linearProject(that.data[seriesName],index)+that.pointsOffset[seriesName];return Math.round(100*y)/100},getDerivedFieldsAfterSummary:function(){var projectionMetrics=_.filter(self.series,function(s){return-1!==s.name.indexOf("Projection")}),metrics=_.map(projectionMetrics,function(m){return{as:m.description,projectOn:m.projectOn,f:function(row,index,summaryMetrics,seriesData){var p=self.calcProjectionPoint(this.projectOn,row,index,summaryMetrics,seriesData);return p}}});return metrics},defined:function(v){return!_.isUndefined(v)&&!_.isNull(v)}}});
                function LineFitter(){this.count=0,this.sumX=0,this.sumX2=0,this.sumXY=0,this.sumY=0}function linearProject(data,x){for(var fitter=new LineFitter,i=0;data.length>i;i++)fitter.add(i,data[i]);return fitter.project(x)}function projectToZero(data,x){for(var start=x;linearProject(data,start)>0;)start+=1;return start}LineFitter.prototype={add:function(x,y){this.count++,this.sumX+=x,this.sumX2+=x*x,this.sumXY+=x*y,this.sumY+=y},project:function(x){var det=this.count*this.sumX2-this.sumX*this.sumX,offset=(this.sumX2*this.sumY-this.sumX*this.sumXY)/det,scale=(this.count*this.sumXY-this.sumX*this.sumY)/det;return offset+x*scale}};
                function getReleaseTimeBox(app){var timeboxScope=app.getContext().getTimeboxScope(),tbName=null;if(timeboxScope){var record=timeboxScope.getRecord();tbName=record.get("Name")}else tbName="";return tbName}function wsapiQuery(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}function snapshotQuery(config,callback){var storeConfig={find:config.find,fetch:config.fetch,hydrate:config.hydrate,autoLoad:!0,pageSize:1e4,limit:"Infinity",listeners:{scope:this,load:function(store,snapshots,success){console.log("snapshots:",snapshots.length),callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)}function pointsUnitType(type){return"Points"==type}function createSeriesArray(){return[{name:"PreliminaryEstimate",description:"Preliminary Estimate",field:"CalcPreliminaryEstimate",display:"line",f:"sum",color:"Orange"},{name:"StoryPoints",description:"Story Points",field:"LeafStoryPlanEstimateTotal",display:"line",f:"sum",color:"DarkGray"},{name:"StoryCount",description:"Story Count",field:"LeafStoryCount",display:"line",f:"sum",color:"DarkGray"},{name:"StoryPointsProjection",description:"Scope Projection",projectOn:"Story Points",color:"LightGray"},{name:"StoryCountProjection",description:"Count Projection",projectOn:"Story Count",color:"LightGray"},{name:"AcceptedStoryPoints",description:"Accepted Points",field:"AcceptedLeafStoryPlanEstimateTotal",display:"line",f:"sum",color:"Green"},{name:"AcceptedStoryCount",description:"Accepted Count",field:"AcceptedLeafStoryCount",display:"line",f:"sum",color:"Green"},{name:"AcceptedPointsProjection",description:"Accepted Projection",projectOn:"Accepted Points",color:"LightGray"},{name:"AcceptedCountProjection",description:"Accepted Count Projection",projectOn:"Accepted Count",color:"LightGray"},{name:"FeatureCount",description:"Feature Count",field:"ObjectID",display:"column",f:"count",color:"Blue"},{name:"FeatureCountCompleted",description:"Completed Feature Count",field:"Completed",display:"column",f:"sum",color:"Green"}]}function createColorsArray(series){var colors=[];return _.each(series,function(s,i){if(i>0){var as=_.find(app.series,function(a){return a.description===s.name});colors.push(as.color)}}),colors}function trimHighChartsConfig(hc){var today=new Date;return _.each(hc,function(series,i){-1===series.name.indexOf("Projection")&&-1===series.name.indexOf("label")&&_.each(series.data,function(point,x){Date.parse(hc[0].data[x])>today&&(series.data[x]=null)}),-1!==series.name.indexOf("Projection")&&(_.each(series.data,function(point,x){today>Date.parse(hc[0].data[x])&&(series.data[x]=null)}),series.dashStyle="dash")}),hc}

            Rally.launchApp('CustomApp', {
                name:"tagged-feature-burnup",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
